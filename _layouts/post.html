<!DOCTYPE HTML>
<html lang="en" >
    <head>

        {%- include head.html -%}

        {% if page.previous %}
            <link rel="prev" href="{{site.baseurl}}{{page.previous.url}}" />
        {% else %}
            <link rel="prev" href="{{site.baseurl}}/" />
        {% endif %}

        {% if page.next %}
            <link rel="next" href="{{site.baseurl}}{{page.next.url}}" />
        {% endif %}

    </head>
    <body>
        <div class="book">

            {%- include toc-date.html -%}

            <div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        {% if page.title %}
                            <a href="." >{{ page.title | escape }}</a>
                        {% else %}
                            <a href="." >{{ site.title | escape }}</a>
                        {% endif %}
                    </h1>
                </div>

                <div class="body-inner">
                    {%- include body.html -%}

                    {% if page.previous %}
                        <a href="{{site.baseurl}}{{page.previous.url}}" class="navigation navigation-prev navigation-unique" aria-label="Previous page: {{page.previous.title}}">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    {% else %}
                        <a href="{{site.baseurl}}/" class="navigation navigation-prev navigation-unique" aria-label="Previous page: {{site.title}}">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    {% endif %}

                    {% if page.next %}
                        <a href="{{site.baseurl}}{{page.next.url}}" class="navigation navigation-next navigation-unique" aria-label="Next page: {{page.next.title}}">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({%- include metadata-post.json.tpl -%});
            });
            </script>
            
        </div>

        {%- include footer.html -%}
        <script>
        function adjustGraphWidth(wideGraph, bookBody) {
            if (!wideGraph || !bookBody) return;
            const availableWidth = bookBody.offsetWidth;
            wideGraph.style.maxWidth = availableWidth + "px";
            wideGraph.style.width = availableWidth + "px";
            console.log("[GRAPH DEBUG] Width adjusted to:", availableWidth);
        }
        
        function waitForIframeAndShowGraph() {
            const maxAttempts = 30;
            let attempts = 0;
        
            function trySetup() {
                const wideGraph = document.querySelector(".wide-graph");
                const iframe = wideGraph?.querySelector("iframe");
                const bookBody = document.querySelector(".book-body");
        
                if (!wideGraph || !iframe || !bookBody) {
                    if (attempts++ < maxAttempts) {
                        console.log("[GRAPH DEBUG] Waiting... attempt", attempts);
                        return setTimeout(trySetup, 200);
                    } else {
                        console.warn("[GRAPH DEBUG] Gave up waiting for iframe.");
                        return;
                    }
                }
        
                wideGraph.style.visibility = "hidden";
        
                iframe.onload = function () {
                    console.log("[GRAPH DEBUG] iframe onload triggered");
                    adjustGraphWidth(wideGraph, bookBody);
                    wideGraph.style.visibility = "visible";
                };
        
                // Fallback in case iframe is cached and onload doesn't fire
                setTimeout(() => {
                    if (wideGraph.style.visibility !== "visible") {
                        console.log("[GRAPH DEBUG] Fallback showing iframe");
                        adjustGraphWidth(wideGraph, bookBody);
                        wideGraph.style.visibility = "visible";
                    }
                }, 1200);
        
                // Adjust on resize
                window.addEventListener("resize", () => adjustGraphWidth(wideGraph, bookBody));
        
                // Observe sidebar changes
                const sidebar = document.querySelector(".book-summary");
                if (sidebar) {
                    const observer = new MutationObserver(() => adjustGraphWidth(wideGraph, bookBody));
                    observer.observe(sidebar, { attributes: true, childList: true, subtree: true });
                }
            }
        
            trySetup();
        }
        
        // ✅ Hook into GitBook navigation
        if (typeof gitbook !== "undefined") {
            gitbook.events.bind("page.change", function () {
                console.log("[GRAPH DEBUG] GitBook navigation detected");
                waitForIframeAndShowGraph();
            });
        }
        
        // ✅ Also handle first-time full page load
        window.addEventListener("load", function () {
            console.log("[GRAPH DEBUG] window.load triggered");
            waitForIframeAndShowGraph();
        });
        </script>
    </body>
</html>